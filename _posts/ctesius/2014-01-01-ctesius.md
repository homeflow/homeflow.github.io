---
layout: default
title: Working with maps
modal-id: working-with-maps
categories: ctesius
---
Many developers employ the tabbing system for property maps so the user can cycle through the different types: road, streetview and satellite. The first requirement is some events:

{% highlight html %}
{% raw %}
<script>
 Ctesius.addConfig('small_map_element', 'contact_map')
 Ctesius.registerEvent('render_tab', function(tab_name){
  switch(tab_name){
   case 'streetview':
    {{ gmap_for property as streetview in streetview }}
    break;
   case 'satellite':
    {{ gmap_for property as satellite in satellite }}
    break;
   }
 });
</script>
{% endraw %}
{% endhighlight %}

The first line here adds our map to the ``contact_map`` ID or class (seen below). The ``render_tab`` event registers a callback function that renders the appropriate Google map depending on the tab clicked. We then have our anchors and togglable areas:

{% highlight html %}
<a class="selected" id="tab_map" href="#tabs/map">MAP</a>
<a id="tab_streetview" href="#tabs/streetview">STREETVIEW</a>
<a id="tab_satellite" href="#tabs/satellite">SATELLITE</a>
{% endhighlight %}

{% highlight html %}
<div id="togglable_map" class="togglable_area">
 <div id="contact_map"></div>
</div>
<div id="togglable_streetview" class="togglable_area hidden">
 <div id='streetview' class="google_map_container"></div>
</div>
<div id="togglable_satellite" class="togglable_area hidden">
 <div id='satellite' class="google_map_container"></div>
</div>
{% endhighlight %}

###Submitting a lead

Email type leads are submitted to Homeflow and then on to the agent by ubiquitous web forms. Here's a simplified version:

{% highlight html %}
{% raw %}
<form action="/properties/{{property.property_id}}/{{property.primary_channel}}/leads" method="post">
 <div id='form_error'></div>
 <label class="text" for="firstname">First name</label>
  <input id="firstname" name="lead_client[first_name]" type="text">
 <label class="text" for="surname">Last name</label>
  <input id="surname" name="lead_client[last_name]" type="text">
 <label class="text" for="email">Email</label>
  <input id="email" name="lead_client[email]" type="email">
 <label class="text" for="telephone">Telephone</label>
  <input id="telephone" name="lead_client[tel_home]" type="text">
 <label class="text" for="message">Message</label>
  <textarea id="message" name="lead[message]" rows="3"></textarea>
 <button type="submit">Send enquiry</button>
</form>
{% endraw %}
{% endhighlight %}

If you are familiar with forms, which we're sure you are, there will be nothing new here to you. The only requirements are the names of the fields as well as the form action. The form error div near the top is reserved for any lead sending errors. Once a lead is sent, a ``flash message`` can be displayed. We have a whole array of flash notices that are used depending on the response back from the server and to display the notices, all you need to do is and the alert location div to your ``application.liquid`` or on the subject page itself:

{% highlight html %}
<div id='alert_location'></div>
{% endhighlight %}

###Working with agencies

More commonly found on portals, the agency page acts as the top level holdall for the agency's branches, staff, contact details and so on. The Ctesius app comes with a URL pattern that can describe the agency, the branch and the staff, should you need it to. Let's look at what a typical agency page might contain.

###The agency show page

Anything agency related will reside in the ``agencies`` folder in your Rails directory structure and your show page will follow the normal format of ``show.liquid``. Let's start to build the page using the agency name, agency description and the agency's portal logo with a fallback to their default logo:

{% highlight html %}
{% raw %}
<h1>{{agency.name}}</h1>
{% endraw %}
{% endhighlight %}

{% highlight html %}
{% raw %}
{% if agency.portal_logo %}
 <img src="{{agency.portal_logo | url_for_agency_logo : "200x_"}}" />
{% elsif agency.logo %}
 <img src="{{agency.logo | url_for_agency_logo : "200x_"}}" />
{% endif %}
{% endraw %}
{% endhighlight %}

``{% raw %}{{agency.description}}{% endraw %}``

Next, let's add a Google style map to our show page - note that this will show the branches belonging to an agency:

{% highlight html %}
<div id='agency_map'></div>
{% endhighlight %}

{% highlight html %}
{% raw %}
<script>
 {{ gmap_for agency.branches as roadmap in agency_map }}
</script>
{% endraw %}
{% endhighlight %}

Don't forget to give your map div a height and a width setting in your CSS.

If you would prefer to use a Leaflet style map:

{% highlight html %}
<div id='branches_map'></div>
{% endhighlight %}

{% highlight html %}
{% raw %}
<script type="text/javascript">
 Ctesius.addConfig('branch_map_element', 'branches_map');
 Ctesius.addConfig('branches', {{ include_as_json branches/branches_list }});
</script>
{% endraw %}
{% endhighlight %}

Now let's extract the branches of an agency, including their branch pic or logo, description etc:

{% highlight html %}
{% raw %}
{% for branch in agency.branches_ordered_alphanumerically %}
 {% include "branches/branch_small" %}
{% endfor %}
{% endraw %}
{% endhighlight %}

Note that we're ordering the branches alphabetically using a helper function and we're reusing our ``branch_small``. Not only is this excellent reuse, but it means if your branch_small layout is sorted, it should work out of the box on you agencies pages. In addition, when you need to make a change to it, it will be reflected on all pages that use it.

Finally, let's see how we can extract some social media links from the CRM:

{% highlight html %}
{% raw %}
{% if agency.has_social_links %}
 <div class="agency_social">
  {% if agency.facebook_uri %}
   <a href="{{agency.facebook_uri }}" target="_blank"><img src="{{'facebook' | theme_image_url}}" width="32" height="32"></a>
  {% endif %}
  {% if agency.twitter_uri %}
   <a href="{{agency.twitter_uri }}" target="_blank"><img src="{{'twitter' | theme_image_url}}" width="32" height="32"></a>
  {% endif %}
  {% if agency.linkedin_uri %}
   <a href="{{agency.linkedin_uri }}" target="_blank"><img src="{{'linkedin' | theme_image_url}}" width="32" height="32"></a>
  {% endif %}
  {% if agency.googleplus_uri %}
   <a href="{{agency.googleplus_uri }}" target="_blank"><img src="{{'google-plus' | theme_image_url}}" width="32" height="32"></a>
  {% endif %}
 </div>
{% endif %}
{% endraw %}
{% endhighlight %}

This block of code first executes a ``has_social_links`` function - this checks whether any one of the standard social media slots has a value. If at least one does, it will execute the block. We then use individual agency drop checks to see if the URI is available and output a theme image linking to the URI if so.

###Working with branches

Way back at beginning of the documentation we outlined the Rails folder structure we must use in order to retrieve property, agency, branch information and so on. To retrieve everything related to a branch, to perform branch searches and generally build the template up, we need to work in our ``branches`` folder. Let's start with the index file.

###The branches index

As we saw with the ``properties index``, our index pages are called when no seach criteria is given and we just want a flat list of all properties, branches, etc. A branches index route would simply be: ``http://www.agency_domain.com/branches``. On our index page we can add the following code:

{% highlight html %}
{% raw %}
{% if branches != empty %}
 {% for branch in branches %}
  {% include "branches/branch_small" %}
 {% endfor %}
{% endif %}
{% endraw %}
{% endhighlight %}

This construct is exactly the same as a properties loop seen before except we are referencing our branches collection as well as including a ``branch_small`` partial for each returned branch. A ``branch_small`` might look something like:

{% highlight html %}
{% raw %}
<div class="branch">
 {% if branch.agency.portal_logo %}
  <img src="{{ branch.agency.portal_logo | url_for_agency_logo : "150!" }}" />
 {% else %}
  <img src="{{ 'awaiting-image.png' | theme_image_url }}" />
 {% endif %}
 <div class="details">
  <h3>
   <a href="{{ branch | url_for_branch}}">{{branch.name}} branch</a>
  </h3>
  <p class="content">
   {{branch.description | strip_tags | truncate : 250}}
  </p>
  <p>
   <a href="{{ branch | url_for_branch}}">More Information</a>
  </p>
 </div>
</div>
{% endraw %}
{% endhighlight %}

Here we are checking whether the agency's portal logo has been set and if it has, we output it in the source. Note you could use ``{% raw %}{{ branch.photo | url_for_generic_image: "150!" }}{% endraw %}`` instead, which would retrieve the branch photo as set in the branches area of the agency or portal admin. This photo is normally a shop front image or something similar. As another alternative, you could use the overall agency logo: ``{% raw %}{{ agency.logo | url_for_agency_logo : '150!'}}{% endraw %}``. Note that we've got a backup coded in to output a standard holding image if no portal logo is available. This is a ``theme_image_url`` - you may remember theme images reside in ``/assets/images``.

One new element here is the bang (explanation mark) after the width dimension. We've built in some nifty Liquid filters that give you some flexiblity when requesting images from the server. In this instance we're saying: get us the agency portal logo and resize it so the width and height are no more than 150 pixels. Other options here are to specify the dimensions exactly or specify a height or a width, then get Liquid to automatically set the other dimension whilst retaining the aspect ratio - we do this by using an underscore where the dimension you want to calculate would normally be, e.g: "150x_".

Next we're outputting the branch name and wrapping it in the URL for the branch. We then go on to output the branch description. Note that in some instances you might be able to guarantee that the description has been added, if you can't then you can wrap the output in an ``{% raw %}{% if branch.description }}{% endraw %}``. Note the truncate filter that we've seen before. There's also a new filter here called ``strip_tags``. Along with ``strip_html`` and ``strip_links`` it strips the description of any unwanted HTML tags and links.

Not every theme will call for a ``branch_small`` partial to be used - some might just have the name of the branch and a link, whilst others might have the name, link and a map of the branches.

###Working with branch maps

Homeflow supports a variety of map types which you can extend with custom pins, overlays and so on. The first and easiest map to set-up is the Leafleft.js map type. To get this up and running on the branches index page, start by adding:

{% highlight html %}
{% raw %}
<script>
 Ctesius.addConfig('branch_map_element', 'branch_map');
 Ctesius.addConfig('branches', {% include_as_json branches/branches_list %});
</script>
{% endraw %}
{% endhighlight %}

This is the first time we've seen a built-in Ctesius ``addConfig`` function - the first ``addConfig`` assigns our branch map to the element ``branch_map`` whilst the second outputs a dump of JSON branch information for use on the front end. Next we need to declare our ``div`` to apply the map to:

``<div id="branch_map"></div>``

Don't forget to give your map ID or class and height and/or width to get it to show up. This should be enough to get your Leaflet branch map showing with a pin for each branch. The map bubbles have a fairly basic presentation that's fine for most, but if you would like to customise your pin, you can override ``_branch_map_pin.liquid`` in your ``js_templates`` folder and customise the layout and styles as necessary. Note that you'll need the basic layout code in the override, if you don't have this, pop us a line or grab it from another theme if we've given you access.

If you would prefer a Google style map you still need the ``addConfig branches`` code seen before, but this time, instead of your ``addConfig branch_map``, we need:

``{% raw %}{{ gmap_for agency.branches as roadmap in branch_map }}{% endraw %}``

This should then populate your ``branch_map`` div with a Google style map. Note that we're using the ``agency.branches`` ``drop`` to access the branches belonging to an agency.

###Branch searching

If you're building a portal or larger agency theme, you will pleased to know that users can search for your branches using our geo location database. This comes complete with a handy AJAX style auto suggest location based on the town or city the user enters. To get up and running, first we need to add our form:

{% highlight html %}
{% raw %}
<form action="/branches" id="search" method="get">
 <input type="text" name="location" id="location" class="autocomplete_location">
 <input type='hidden' name='place_id' value='{{place_id}}' class='autocomplete_location_result' />
 <button value="Search" type="submit"></button>
</form>
{% endraw %}
{% endhighlight %}

Next where you branch results need to be, we have:

{% highlight html %}
{% raw %}
{% if branches != empty %}
 {% for branch in branches %}
  {% include 'branches/branch_small' %}
 {% endfor %}
{% else %}
 <h1>Sorry, no branches were found.</h1>
{% endif %}
{% endraw %}
{% endhighlight %}

The output here will be an index of branches, but if we submit our form with a location, our branches controller will go off, fetch the results and display them in place of the index results.

###Branch titles and pagination

Much like we saw earlier in the documentation with property results, it's useful to output some titles and especially useful to output pagination if the branch results are on several pages. There's a number of ways that you can deal with titles - here's one such example:

{% highlight html %}
{% raw %}
{% if location %}
 {% if location.name != ''%}Branches in {{ location.name }}{% if county %}, {{county.name}}{% endif %}{% endif %}
{% elsif county %}
 Branches in {{ county.name }}
{% elsif postcode %}
 Branches in {{ postcode.postcode }}
{% else %}
 Branches Index
{% endif %}
{% endraw %}
{% endhighlight %}

As you can see, the IF statement checks for the location or location type and outputs the appropriate heading between a heading tag. Remember that if you use the construct multiple times, you can add it to a partial if you wish.

The branches index results comes loaded with the same pagination figures and options we saw in the property results earlier. Here's an example construct:

{% highlight html %}
{% raw %}
Page {{pagination.current_page}} of
{% if pagination.has_next_page %}
 {{pagination.total_count}}
{% else %}
 {{pagination.current_page}}
{% endif %}<br>
{% if pagination.has_prev_page %}
 <a href="{{pagination.previous_page_link}}">&laquo; Previous page</a>
{% endif %}
{% if pagination.has_prev_page and pagination.has_next_page %}
 -
{% endif %}
{% if pagination.has_next_page %}
 <a href="{{pagination.next_page_link}}">Next page &raquo;</a>
{% endif %}
{% endraw %}
{% endhighlight %}

This might output something like:

{% highlight html %}
       Page 2 of 178
« Previous page - Next page »
{% endhighlight %}

By running various IF checks, we can essentially figure out whether there's a next and/or previous page (for example) and format the output accordingly.

###The branch show

Wherever we have a Liquid tag that looks like ``{% raw %}{{ branch | url_for_branch}}{% endraw %}`` or if the branch URL is called, the branch show page will get called into action. As with all of the subjects, the branch show page is simply titled ``show.liquid`` and lives in the branches folder.

The branch show page supports many of the things we saw on the property show page - for instance, you could have a JavaScript based carousel showing branch photos, list the staff members belonging to a branch, output the branch description and so on. What information you fetch and how you display it will of course depend on your design, but let's run through the basics:

To get the branch name we use the branch drop and name: ``{% raw %}{{branch.name}}{% endraw %}``. Moving on, we can then fetch the branch description:

{% highlight html %}
{% raw %}
{% if branch.description_with_agency_fallback %}
<p>
 {{branch.description_with_agency_fallback | strip_html}}
</p>
{% endif %}
{% endraw %}
{% endhighlight %}

This nifty bit of code will try and get the branch description, but if it's empty, we'll get the agency description. Note that it is unlikely an agent will not have a description for their branch AND their agency, but it's always good practice to check. Notice also we're stripping the HTML as sometimes some links and other formatting gets added to the description which can wreak havoc on our layout.

Staff profiles are a whole subject unto themselves which we will look at later in the documentation but for now, if you wanted to display some mini profiles with links to full profiles, or just give you branch pages the human touch, you could use something like:

{% highlight html %}
{% raw %}
{% unless branch.staff_profiles.size == 0 &}
<div class="sm_staff_gallery">
{% for staff_member in branch.staff_profiles limit:6 %}
 {% if staff_member.avatar %}
  <a href="{{ staff_member | url_for_staff_member}}" title="{{staff_member.name}}">
  <img src="{{ staff_member.avatar | url_for_staff_profile_avatar : "40x40" }}" title="{{staff_member.name}}">
  </a>
 {% else %}
  <a href="{{ staff_member | url_for_staff_member}}" title="{{staff_member.name}}">
  <img src="/liquid_assets/images/sp.jpg" height="40" width="40" title="{{staff_member.name}}">
  </a>
 {% endif %}
{% endfor %}
</div>
{% endunless %}
{% endraw %}
{% endhighlight %}

Everything here should be reasonably familiar to you, though note we've added a ``limit`` to our for loop so that a maximum of six profiles are extracted. Also note that we're referencing a fallback image directly. Whilst this is a quirk of this code copied from a theme, sometimes you might need to reference an image using its relative path. On the whole though, you can just use Liquid and ``theme_image_url``.

###Displaying branch properties

The branch properties page is one where we can thankfully reuse our property loops and pagination figures as seen on the property results. Alternatively we can make use of the tabbing facility and include a function that will return some recent sales or recent lettings. If you would like to get the full results and make use of pagination, we'll need to use the former of the two options as the properties method in the branches controller needs to run to return the results and pagination.

Typically branch pages will make use of our built-in tabbing facility as seen earlier for property results. To get the tabs up and running, you will need the following code:

{% highlight html %}
<ul class="nav-menu nav-tabs">
 <li><a href="#tabs/summary" id="tab_summary" class="selected">Summary</a></li>
 <li><a href="#tabs/team" id="tab_team">Meet our team</a></li>
 <li><a href="#tabs/sales" id="tab_sales">Our sales</a></li>
 <li><a href="#tabs/lettings" id="tab_lettings">Our lettings</a></li>
</ul>
{% endhighlight %}

NB: the Ctesius app will take care of adding ``selected active`` classes to your tabs but you will need to style them.

###Recent sales and lettings

Now we have our tabs, we can add the area that will be toggled on a click. Here's what a togglable sales tab and recent branch sales function looks like:

{% highlight html %}
{% raw %}
{% if branch.recent_sales_properties != empty %}
<script>
 {% assign properties = branch.recent_sales_properties %}
 sales_property_for_config = {% include_as_json properties/properties_list %}.properties
</script>
<div id="togglable_sales" class="togglable_area clearfix hidden">
<h2>Latest sale listings for {{branch.name}}</h2>
 {% for property in branch.recent_sales_properties limit: 20 %}
  {% include "properties/property_small" %}
 {% endfor %}
</div>
{% endif %}
{% endraw %}
{% endhighlight %}

Here we're making us of one of Ctesius's many built-in functions - this one gets recent properties that the branch has added or we have received via a feed. To get this up and running we literally call the function which returns the JSON we need. We then use the good ol' properties loop to output the results, whilst reusing our ``property_small``. Note that we've wrapped this whole block in an IF statement that checks if the function returns empty. It would be good practice to hide the link to the tab if the function has no results too.

To get this up and running for lettings, just substitute any reference to sales for lettings.

###All branch properties

If you would like to display all properties that belong to a branch with pagination, we'll need a ``properties.liquid`` file within the branches folder. Once you have this you can start to build up the layout. This will most likely be a hybrid of your properties result page and your branch show page so use partials where possible and reuse what you've already written.

To start with, you might want to add a title:

{% highlight html %}
{% raw %}
<h1>{{agency.name}} - {{branch.name}} branch - All {{current_channel}}</h1>
{% endraw %}
{% endhighlight %}

Not much new here but it's worth knowing that ``{% raw %}{{current_channel}}{% endraw %}`` will return either a 'Sales' or 'Lettings' string. Next you might want some tabs that will enable the user to navigate around:

{% highlight html %}
{% raw %}
<ul class="nav-menu nav-tabs">
 <li><a href="{{branch | url_for_branch : branch.agency}}#tabs/summary" id="tab_summary">Summary</a></li>
 <li><a href="#tabs/team" id="tab_team">Meet our team</a></li>
 {% if branch.sales_branch_properties_count > 0 %}
  <li><a href="{{branch | url_for_branch : branch.agency}}/sales" id="sales">Our sales</a></li>
 {% endif %}
 {% if branch.lettings_branch_properties_count > 0 %}
  <li><a href="{{branch | url_for_branch : branch.agency}}/lettings" id="lets">Our lettings</a></li>
 {% endif %}
</ul>
{% endraw %}
{% endhighlight %}

The first two tabs here would be hidden tabs on the page that get selected and displayed on a click. The branch properties tabs however, need to go through the branch properties controller to get the results. All we need do here is specify the appropriate branch URL with ``/sales`` or ``/lettings``. If you're developing a portal with agencies that have multiple branches, you will need to use ``{% raw %}{{branch | url_for_branch : branch.agency}}{% endraw %}`` in your URL, else you can just use ``{% raw %}{{branch | url_for_branch}}{% endraw %}``.

Next we need to output the actual results that are returned from our request. Thankfully this is just the same as outputting our property results seen earlier so you will have your pagination header, property loop, property small output and footer pagination (if required).
