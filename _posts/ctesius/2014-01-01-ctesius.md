---
layout: default
title: Working with branch maps
modal-id: working-with-branch-maps
categories: ctesius
---
Homeflow supports a variety of map types which you can extend with custom pins, overlays and so on. The first and easiest map to set-up is the Leafleft.js map type. To get this up and running on the branches index page, start by adding:

{% highlight html %}
{% raw %}
<script>
 Ctesius.addConfig('branch_map_element', 'branch_map');
 Ctesius.addConfig('branches', {% include_as_json branches/branches_list %});
</script>
{% endraw %}
{% endhighlight %}

This is the first time we've seen a built-in Ctesius ``addConfig`` function - the first ``addConfig`` assigns our branch map to the element ``branch_map`` whilst the second outputs a dump of JSON branch information for use on the front end. Next we need to declare our ``div`` to apply the map to:

``<div id="branch_map"></div>``

Don't forget to give your map ID or class and height and/or width to get it to show up. This should be enough to get your Leaflet branch map showing with a pin for each branch. The map bubbles have a fairly basic presentation that's fine for most, but if you would like to customise your pin, you can override ``_branch_map_pin.liquid`` in your ``js_templates`` folder and customise the layout and styles as necessary. Note that you'll need the basic layout code in the override, if you don't have this, pop us a line or grab it from another theme if we've given you access.

If you would prefer a Google style map you still need the ``addConfig branches`` code seen before, but this time, instead of your ``addConfig branch_map``, we need:

``{% raw %}{{ gmap_for agency.branches as roadmap in branch_map }}{% endraw %}``

This should then populate your ``branch_map`` div with a Google style map. Note that we're using the ``agency.branches`` ``drop`` to access the branches belonging to an agency.

###Branch searching

If you're building a portal or larger agency theme, you will pleased to know that users can search for your branches using our geo location database. This comes complete with a handy AJAX style auto suggest location based on the town or city the user enters. To get up and running, first we need to add our form:

{% highlight html %}
{% raw %}
<form action="/branches" id="search" method="get">
 <input type="text" name="location" id="location" class="autocomplete_location">
 <input type='hidden' name='place_id' value='{{place_id}}' class='autocomplete_location_result' />
 <button value="Search" type="submit"></button>
</form>
{% endraw %}
{% endhighlight %}

Next where you branch results need to be, we have:

{% highlight html %}
{% raw %}
{% if branches != empty %}
 {% for branch in branches %}
  {% include 'branches/branch_small' %}
 {% endfor %}
{% else %}
 <h1>Sorry, no branches were found.</h1>
{% endif %}
{% endraw %}
{% endhighlight %}

The output here will be an index of branches, but if we submit our form with a location, our branches controller will go off, fetch the results and display them in place of the index results.

###Branch titles and pagination

Much like we saw earlier in the documentation with property results, it's useful to output some titles and especially useful to output pagination if the branch results are on several pages. There's a number of ways that you can deal with titles - here's one such example:

{% highlight html %}
{% raw %}
{% if location %}
 {% if location.name != ''%}Branches in {{ location.name }}{% if county %}, {{county.name}}{% endif %}{% endif %}
{% elsif county %}
 Branches in {{ county.name }}
{% elsif postcode %}
 Branches in {{ postcode.postcode }}
{% else %}
 Branches Index
{% endif %}
{% endraw %}
{% endhighlight %}

As you can see, the IF statement checks for the location or location type and outputs the appropriate heading between a heading tag. Remember that if you use the construct multiple times, you can add it to a partial if you wish.

The branches index results comes loaded with the same pagination figures and options we saw in the property results earlier. Here's an example construct:

{% highlight html %}
{% raw %}
Page {{pagination.current_page}} of
{% if pagination.has_next_page %}
 {{pagination.total_count}}
{% else %}
 {{pagination.current_page}}
{% endif %}<br>
{% if pagination.has_prev_page %}
 <a href="{{pagination.previous_page_link}}">&laquo; Previous page</a>
{% endif %}
{% if pagination.has_prev_page and pagination.has_next_page %}
 -
{% endif %}
{% if pagination.has_next_page %}
 <a href="{{pagination.next_page_link}}">Next page &raquo;</a>
{% endif %}
{% endraw %}
{% endhighlight %}

This might output something like:

{% highlight html %}
       Page 2 of 178
« Previous page - Next page »
{% endhighlight %}

By running various IF checks, we can essentially figure out whether there's a next and/or previous page (for example) and format the output accordingly.

###The branch show

Wherever we have a Liquid tag that looks like ``{% raw %}{{ branch | url_for_branch}}{% endraw %}`` or if the branch URL is called, the branch show page will get called into action. As with all of the subjects, the branch show page is simply titled ``show.liquid`` and lives in the branches folder.

The branch show page supports many of the things we saw on the property show page - for instance, you could have a JavaScript based carousel showing branch photos, list the staff members belonging to a branch, output the branch description and so on. What information you fetch and how you display it will of course depend on your design, but let's run through the basics:

To get the branch name we use the branch drop and name: ``{% raw %}{{branch.name}}{% endraw %}``. Moving on, we can then fetch the branch description:

{% highlight html %}
{% raw %}
{% if branch.description_with_agency_fallback %}
<p>
 {{branch.description_with_agency_fallback | strip_html}}
</p>
{% endif %}
{% endraw %}
{% endhighlight %}

This nifty bit of code will try and get the branch description, but if it's empty, we'll get the agency description. Note that it is unlikely an agent will not have a description for their branch AND their agency, but it's always good practice to check. Notice also we're stripping the HTML as sometimes some links and other formatting gets added to the description which can wreak havoc on our layout.

Staff profiles are a whole subject unto themselves which we will look at later in the documentation but for now, if you wanted to display some mini profiles with links to full profiles, or just give you branch pages the human touch, you could use something like:

{% highlight html %}
{% raw %}
{% unless branch.staff_profiles.size == 0 &}
<div class="sm_staff_gallery">
{% for staff_member in branch.staff_profiles limit:6 %}
 {% if staff_member.avatar %}
  <a href="{{ staff_member | url_for_staff_member}}" title="{{staff_member.name}}">
  <img src="{{ staff_member.avatar | url_for_staff_profile_avatar : "40x40" }}" title="{{staff_member.name}}">
  </a>
 {% else %}
  <a href="{{ staff_member | url_for_staff_member}}" title="{{staff_member.name}}">
  <img src="/liquid_assets/images/sp.jpg" height="40" width="40" title="{{staff_member.name}}">
  </a>
 {% endif %}
{% endfor %}
</div>
{% endunless %}
{% endraw %}
{% endhighlight %}

Everything here should be reasonably familiar to you, though note we've added a ``limit`` to our for loop so that a maximum of six profiles are extracted. Also note that we're referencing a fallback image directly. Whilst this is a quirk of this code copied from a theme, sometimes you might need to reference an image using its relative path. On the whole though, you can just use Liquid and ``theme_image_url``.

###Displaying branch properties

The branch properties page is one where we can thankfully reuse our property loops and pagination figures as seen on the property results. Alternatively we can make use of the tabbing facility and include a function that will return some recent sales or recent lettings. If you would like to get the full results and make use of pagination, we'll need to use the former of the two options as the properties method in the branches controller needs to run to return the results and pagination.

Typically branch pages will make use of our built-in tabbing facility as seen earlier for property results. To get the tabs up and running, you will need the following code:

{% highlight html %}
<ul class="nav-menu nav-tabs">
 <li><a href="#tabs/summary" id="tab_summary" class="selected">Summary</a></li>
 <li><a href="#tabs/team" id="tab_team">Meet our team</a></li>
 <li><a href="#tabs/sales" id="tab_sales">Our sales</a></li>
 <li><a href="#tabs/lettings" id="tab_lettings">Our lettings</a></li>
</ul>
{% endhighlight %}

NB: the Ctesius app will take care of adding ``selected active`` classes to your tabs but you will need to style them.

###Recent sales and lettings

Now we have our tabs, we can add the area that will be toggled on a click. Here's what a togglable sales tab and recent branch sales function looks like:

{% highlight html %}
{% raw %}
{% if branch.recent_sales_properties != empty %}
<script>
 {% assign properties = branch.recent_sales_properties %}
 sales_property_for_config = {% include_as_json properties/properties_list %}.properties
</script>
<div id="togglable_sales" class="togglable_area clearfix hidden">
<h2>Latest sale listings for {{branch.name}}</h2>
 {% for property in branch.recent_sales_properties limit: 20 %}
  {% include "properties/property_small" %}
 {% endfor %}
</div>
{% endif %}
{% endraw %}
{% endhighlight %}

Here we're making us of one of Ctesius's many built-in functions - this one gets recent properties that the branch has added or we have received via a feed. To get this up and running we literally call the function which returns the JSON we need. We then use the good ol' properties loop to output the results, whilst reusing our ``property_small``. Note that we've wrapped this whole block in an IF statement that checks if the function returns empty. It would be good practice to hide the link to the tab if the function has no results too.

To get this up and running for lettings, just substitute any reference to sales for lettings.

###All branch properties

If you would like to display all properties that belong to a branch with pagination, we'll need a ``properties.liquid`` file within the branches folder. Once you have this you can start to build up the layout. This will most likely be a hybrid of your properties result page and your branch show page so use partials where possible and reuse what you've already written.

To start with, you might want to add a title:

{% highlight html %}
{% raw %}
<h1>{{agency.name}} - {{branch.name}} branch - All {{current_channel}}</h1>
{% endraw %}
{% endhighlight %}

Not much new here but it's worth knowing that ``{% raw %}{{current_channel}}{% endraw %}`` will return either a 'Sales' or 'Lettings' string. Next you might want some tabs that will enable the user to navigate around:

{% highlight html %}
{% raw %}
<ul class="nav-menu nav-tabs">
 <li><a href="{{branch | url_for_branch : branch.agency}}#tabs/summary" id="tab_summary">Summary</a></li>
 <li><a href="#tabs/team" id="tab_team">Meet our team</a></li>
 {% if branch.sales_branch_properties_count > 0 %}
  <li><a href="{{branch | url_for_branch : branch.agency}}/sales" id="sales">Our sales</a></li>
 {% endif %}
 {% if branch.lettings_branch_properties_count > 0 %}
  <li><a href="{{branch | url_for_branch : branch.agency}}/lettings" id="lets">Our lettings</a></li>
 {% endif %}
</ul>
{% endraw %}
{% endhighlight %}

The first two tabs here would be hidden tabs on the page that get selected and displayed on a click. The branch properties tabs however, need to go through the branch properties controller to get the results. All we need do here is specify the appropriate branch URL with ``/sales`` or ``/lettings``. If you're developing a portal with agencies that have multiple branches, you will need to use ``{% raw %}{{branch | url_for_branch : branch.agency}}{% endraw %}`` in your URL, else you can just use ``{% raw %}{{branch | url_for_branch}}{% endraw %}``.

Next we need to output the actual results that are returned from our request. Thankfully this is just the same as outputting our property results seen earlier so you will have your pagination header, property loop, property small output and footer pagination (if required).
